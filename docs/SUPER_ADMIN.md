# Панель Super Admin

## Обзор

Панель Super Admin предназначена для владельцев платформы. Она позволяет управлять всеми организациями и их пользователями.

## Доступ

**URL**: `/super-admin`

**Требования**: `isSuperAdmin: true` в профиле пользователя

**Тестовый аккаунт**:
- Email: `admin@contour.com`
- Пароль: `admin123`

## Функциональность

### 1. Управление организациями

#### Список организаций (`/super-admin/organizations`)

Отображает все организации с:
- Название
- ID организации
- Количество пользователей
- Количество туров
- Кнопки управления и удаления

#### Создание организации (`/super-admin/organizations/create`)

**Поля**:
- Название организации (обязательно)

**После создания**:
- Организация создается с уникальным ID
- Доступ к организации осуществляется через `organizationId` в сессии пользователя
- Можно сразу добавлять пользователей

#### Просмотр и редактирование организации (`/super-admin/organizations/:id`)

**Блок "Информация об организации"**:
- Просмотр названия и ID
- Редактирование названия
- Сохранение изменений

**Блок "Пользователи организации"**:
- Список всех пользователей организации
- Добавление новых пользователей
- Редактирование существующих пользователей
- Изменение пароля пользователей
- Удаление пользователей

#### Удаление организации

- Удаление с подтверждением (двойной клик)
- Каскадное удаление всех связанных данных:
  - Пользователи организации
  - Туры организации

### 2. Управление пользователями организаций

#### Создание пользователя

**Поля**:
- Email (обязательно, уникальный)
- Имя (обязательно)
- Пароль (обязательно, минимум 6 символов)
- Роль:
  - **Администратор** - полные права в организации
  - **Менеджер** - ограниченные права
  - **Гид** - базовые права

**Валидация**:
- Email должен быть уникальным
- Пароль автоматически хешируется (bcrypt, 10 раундов)

#### Редактирование пользователя

**Можно изменить**:
- Имя
- Email (с проверкой уникальности)
- Роль

**Нельзя изменить**:
- ID пользователя
- Принадлежность к организации (создается при создании)

#### Изменение пароля

- Отдельная форма для безопасности
- Минимум 6 символов
- Автоматическое хеширование

#### Удаление пользователя

- С подтверждением
- Каскадное удаление связанных данных

## API Endpoints (tRPC)

### Organization

```typescript
// Получить все организации
trpc.organization.getAll.useQuery();

// Получить организацию по ID
trpc.organization.getById.useQuery({ id: string });

// Создать организацию
trpc.organization.create.useMutation({
  name: string
});

// Обновить организацию
trpc.organization.update.useMutation({
  id: string,
  name: string
});

// Удалить организацию
trpc.organization.delete.useMutation({
  id: string
});
```

### User

```typescript
// Получить пользователей организации
trpc.user.getByOrganization.useQuery({
  organizationId: string
});

// Создать пользователя
trpc.user.create.useMutation({
  email: string,
  name: string,
  password: string,
  organizationId: string,
  role: 'ADMIN' | 'MANAGER' | 'GUIDE'
});

// Обновить пользователя
trpc.user.update.useMutation({
  id: string,
  name?: string,
  email?: string,
  role?: 'ADMIN' | 'MANAGER' | 'GUIDE'
});

// Изменить пароль
trpc.user.updatePassword.useMutation({
  id: string,
  password: string
});

// Удалить пользователя
trpc.user.delete.useMutation({
  id: string
});
```

## Безопасность

### Проверка прав

Все эндпоинты защищены `superAdminProcedure`:

```typescript
superAdminProcedure.use(async ({ ctx, next }) => {
  if (!ctx.session.user.isSuperAdmin) {
    throw new TRPCError({ code: 'FORBIDDEN' });
  }
  return next({ ctx });
});
```

### Middleware

`middleware.ts` проверяет доступ к `/super-admin/*`:

```typescript
if (path.startsWith('/super-admin')) {
  if (!token?.isSuperAdmin) {
    return NextResponse.redirect('/login');
  }
}
```

## Схема базы данных

```prisma
model Organization {
  id   String @id @default(cuid())
  name String
  
  users User[]
  tours Tour[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String?
  password String
  
  isSuperAdmin Boolean @default(false)
  
  organizationId String?
  organization   Organization? @relation(...)
  role           UserRole?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  MANAGER
  GUIDE
}
```

## Изменения от первоначального дизайна

### Удалено

- ❌ `slug` - не нужен, используется `organizationId`
- ❌ `description` - не требуется для базовой функциональности

### Добавлено

- ✅ Редактирование названия организации
- ✅ Редактирование пользователей (имя, email, роль)
- ✅ Изменение пароля пользователей
- ✅ Inline редактирование прямо в списке

## Best Practices

### При создании организации

1. Сначала создайте организацию
2. Затем добавьте хотя бы одного администратора
3. Администратор сможет добавлять остальных пользователей

### При редактировании

- Используйте inline редактирование для быстрых изменений
- Пароли меняйте отдельно для безопасности
- Проверяйте уникальность email при изменении

### При удалении

- Удаление организации удаляет все связанные данные
- Нельзя удалить себя (защита от блокировки)
- Всегда требуется подтверждение

## UI Компоненты

### Страницы

- `/super-admin` - Dashboard
- `/super-admin/organizations` - Список организаций
- `/super-admin/organizations/create` - Создание
- `/super-admin/organizations/:id` - Детали и управление

### Layout

`app/(super-admin)/layout.tsx` - общий layout с:
- Header (логотип, email, кнопка выхода)
- Navigation (Главная, Организации)

## Примеры использования

### Создание новой организации

1. Войти как суперадмин
2. Перейти в `/super-admin/organizations`
3. Нажать "Создать организацию"
4. Ввести название
5. Сохранить

### Добавление администратора

1. Открыть организацию
2. Нажать "Добавить пользователя"
3. Заполнить форму:
   - Email
   - Имя
   - Пароль
   - Роль: **Администратор**
4. Сохранить

### Изменение пароля

1. Открыть организацию
2. Найти пользователя
3. Нажать "Пароль"
4. Ввести новый пароль (мин. 6 символов)
5. Подтвердить

## Troubleshooting

### "Организация не найдена"

- Проверьте, что ID корректный
- Проверьте, что организация не удалена

### "Пользователь с таким email уже существует"

- Email должен быть уникальным во всей системе
- Используйте другой email

### "Доступ запрещен"

- Проверьте, что вы вошли как суперадмин
- Проверьте значение `isSuperAdmin` в сессии

## Заключение

Панель Super Admin предоставляет полный контроль над платформой:
- Управление организациями
- Управление всеми пользователями
- Полная изоляция данных между организациями
- Безопасность на всех уровнях

Пользователи организаций работают через `organizationId` в сессии, что обеспечивает автоматическую фильтрацию данных на уровне API.

