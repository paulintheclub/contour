# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω—É—é, –Ω–æ –Ω–∞–¥–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –±–∞–∑–µ **NextAuth.js** —Å **JWT —Ç–æ–∫–µ–Ω–∞–º–∏** –∏ **Credentials –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º**.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. NextAuth.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–§–∞–π–ª**: `server/auth.ts`

```typescript
{
  providers: [CredentialsProvider], // Email + –ø–∞—Ä–æ–ª—å
  session: { strategy: 'jwt' },     // JWT –≤–º–µ—Å—Ç–æ database sessions
}
```

### 2. –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

- **–ê–ª–≥–æ—Ä–∏—Ç–º**: bcrypt
- **–†–∞—É–Ω–¥—ã**: 10
- **–°–æ–ª—å**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–æ–ª—è

```typescript
const hashedPassword = await bcrypt.hash(password, 10);
```

### 3. JWT —Ç–æ–∫–µ–Ω—ã

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–æ–∫–µ–Ω–∞**:
```typescript
{
  id: string;              // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  email: string;           // Email
  isSuperAdmin: boolean;   // –§–ª–∞–≥ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞
  organizationId: string?; // ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
  role: UserRole?;         // –†–æ–ª—å –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
}
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ**: HTTP-only cookie (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ NextAuth)

**–í—Ä–µ–º—è –∂–∏–∑–Ω–∏**: 30 –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é NextAuth)

### 4. –ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤

**–§–∞–π–ª**: `middleware.ts`

Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –ù–∞–ª–∏—á–∏–µ JWT —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—É–ø–µ—Ä–∞–¥–º–∏–Ω / –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
- ‚úÖ –ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã**:
- `/super-admin/*` - —Ç–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
- `/dashboard/*`, `/tours/*`, etc. - —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

## –ü–æ—á–µ–º—É JWT, –∞ –Ω–µ Database Sessions?

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JWT –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ:

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**
   - –ù–µ –Ω—É–∂–Ω—ã —Ç–∞–±–ª–∏—Ü—ã Session, Account, VerificationToken
   - –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ—â–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–∏
   - –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

3. **Stateless**
   - –†–∞–±–æ—Ç–∞–µ—Ç –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏
   - –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç shared session store

4. **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –Ω–∞—à–µ–π –∑–∞–¥–∞—á–∏**
   - –û–¥–∏–Ω —Ç–∏–ø –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (Credentials)
   - –ù–µ –Ω—É–∂–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ—Å—Å–∏–π
   - –ü—Ä–æ—Å—Ç–æ–π flow –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞

### –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ Database Sessions:

- –ù—É–∂–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è OAuth (Google, GitHub)
- –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- –ù—É–∂–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª "–≤—ã–π—Ç–∏ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:

‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π**: bcrypt —Å 10 —Ä–∞—É–Ω–¥–∞–º–∏  
‚úÖ **JWT —Ç–æ–∫–µ–Ω—ã**: –ü–æ–¥–ø–∏—Å–∞–Ω—ã —Å–µ–∫—Ä–µ—Ç–æ–º (`NEXTAUTH_SECRET`)  
‚úÖ **HTTP-only cookies**: –ó–∞—â–∏—Ç–∞ –æ—Ç XSS  
‚úÖ **CSRF –∑–∞—â–∏—Ç–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ NextAuth  
‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: Zod –Ω–∞ —É—Ä–æ–≤–Ω–µ API  
‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç organizationId  

### –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–ø–æ–∫–∞):

‚ö†Ô∏è Rate limiting –Ω–∞ –ª–æ–≥–∏–Ω  
‚ö†Ô∏è –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)  
‚ö†Ô∏è –ò—Å—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–æ–≤  
‚ö†Ô∏è Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è  
‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è  
‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout –ø–æ—Å–ª–µ N –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫  

## Flow –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /login
2. –í–≤–æ–¥ email + password
3. signIn('credentials', { email, password })
4. NextAuth:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç bcrypt.compare(password, hash)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ HTTP-only cookie
5. Middleware:
   - –ß–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å
   - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

```
1. –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
2. Middleware:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç JWT –∏–∑ cookie
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å —Ç–æ–∫–µ–Ω–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –∏ organizationId
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç/–æ—Ç–∫–ª–æ–Ω—è–µ—Ç –¥–æ—Å—Ç—É–ø
```

### –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

```
1. signOut({ callbackUrl: '/' })
2. NextAuth:
   - –£–¥–∞–ª—è–µ—Ç JWT cookie
   - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
```

## API –∑–∞—â–∏—Ç–∞ (tRPC)

### –¢–∏–ø—ã –ø—Ä–æ—Ü–µ–¥—É—Ä:

```typescript
// –ü—É–±–ª–∏—á–Ω–∞—è - –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
publicProcedure

// –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
protectedProcedure

// –¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
superAdminProcedure

// –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
orgAdminProcedure
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö:

```typescript
protectedProcedure.use(async ({ ctx, next }) => {
  if (!ctx.session?.user) {
    throw new TRPCError({ code: 'UNAUTHORIZED' });
  }
  return next({ ctx });
});
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
DATABASE_URL="postgresql://..."
NEXTAUTH_SECRET="random-32-char-string"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
NEXTAUTH_URL="http://localhost:3000"  # auto-detect –≤ production
NODE_ENV="development"
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π `NEXTAUTH_SECRET` –≤ production:

```bash
openssl rand -base64 32
```

## –¢–∏–ø—ã TypeScript

**–§–∞–π–ª**: `types/next-auth.d.ts`

–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã NextAuth —Å –Ω–∞—à–∏–º–∏ –ø–æ–ª—è–º–∏:

```typescript
interface Session {
  user: {
    id: string;
    email: string;
    name?: string;
    isSuperAdmin: boolean;
    organizationId?: string;
    role?: UserRole;
  };
}
```

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Å–µ—Å—Å–∏–µ–π.

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

- **JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**: 0 –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤—Å—ë –≤ —Ç–æ–∫–µ–Ω–µ)
- **Database —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**: 1-2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å

### –†–∞–∑–º–µ—Ä JWT —Ç–æ–∫–µ–Ω–∞:

~200-300 –±–∞–π—Ç (—Å–∂–∞—Ç—ã–π –∏ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π)

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:

NextAuth –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–µ—à–∏—Ä—É–µ—Ç session –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Å –ø–æ–º–æ—â—å—é `useSession()` —Ö—É–∫–∞.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- ‚úÖ –ü—Ä–æ—Å—Ç–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è production
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞
- ‚úÖ –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- Database sessions
- 2FA
- Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é

–ù–æ –¥–ª—è MVP —ç—Ç–æ–≥–æ –≤–ø–æ–ª–Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ! üöÄ

