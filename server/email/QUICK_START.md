# ‚ö° Email Integration - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## üéØ –ß—Ç–æ —ç—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ email. –ö–∞–∂–¥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Ö—Ä–∞–Ω—è—â–∏–µ—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –≤ –ë–î.

---

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞ 3 —à–∞–≥–∞

### **–®–∞–≥ 1: –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫** üìã

```bash
npm run email:list
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üìã Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
================================================================================

1. –ú–æ—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è
   ID: cm2abc123def456
   Email –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: ‚úÖ –í–∫–ª—é—á–µ–Ω–∞
   Email: bookings@mytours.com
   üìù –¢–µ—Å—Ç: npm run email:test cm2abc123def456
```

---

### **–®–∞–≥ 2: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é** ‚úÖ

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞:

```bash
npm run email:test test-org-id
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!
üì® –ü–æ–ª—É—á–µ–Ω–æ –ø–∏—Å–µ–º: 5
‚úÖ –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø–∏—Å–µ–º: 2
üéâ Email –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!
```

---

### **–®–∞–≥ 3: –¢–µ—Å—Ç —Å .env (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)** üîß

```bash
npm run email:test-dev
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `.env`:
```env
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
```

---

## üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `npm run email:list` | –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –∏—Ö email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `npm run email:test <org-id>` | –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å email –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –ë–î |
| `npm run email:test-dev` | –¢–µ—Å—Ç —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ .env (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) |

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

### **1. –ü–æ–ª—É—á–∏—Ç—å Gmail App Password**

1. –í–∫–ª—é—á–∏—Ç—å 2FA: https://myaccount.google.com/security
2. –°–æ–∑–¥–∞—Ç—å App Password: https://myaccount.google.com/apppasswords
   - –í—ã–±—Ä–∞—Ç—å: **Mail** ‚Üí **Other (Custom name)**
   - –í–≤–µ—Å—Ç–∏: **Contour Tours**
3. **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å 16 —Å–∏–º–≤–æ–ª–æ–≤** (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)

### **2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Super Admin**

1. –í–æ–π—Ç–∏: `/super-admin`
2. –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
3. –í —Å–µ–∫—Ü–∏–∏ **"Email –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"**:
   - ‚úÖ –í–∫–ª—é—á–∏—Ç—å —á–µ–∫–±–æ–∫—Å
   - üìß Email: `bookings@example.com`
   - üîë App Password: `abcdefghijklmnop`
   - üåê IMAP Host: `imap.gmail.com`
   - üîå Port: `993`
4. –ù–∞–∂–∞—Ç—å **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

‚úÖ –ü–∞—Ä–æ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—à–∏—Ñ—Ä—É–µ—Ç—Å—è!

### **3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**

```bash
npm run email:list
npm run email:test <organization-id>
```

---

## ‚ùå –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö?

### **Invalid credentials**
```
‚ùå IMAP –æ—à–∏–±–∫–∞: Invalid credentials
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π App Password
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–ë–ï–ó –ø—Ä–æ–±–µ–ª–æ–≤** (16 —Å–∏–º–≤–æ–ª–æ–≤)
3. –û–±–Ω–æ–≤–∏—Ç–µ –≤ Super Admin
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç

### **No configuration found**
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –≤ Super Admin
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —á–µ–∫–±–æ–∫—Å "–í–∫–ª—é—á–∏—Ç—å email –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é" ‚úÖ
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### **Connection timeout**
```
‚ùå IMAP –æ—à–∏–±–∫–∞: connect ETIMEDOUT
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- –†–∞–∑—Ä–µ—à–∏—Ç–µ –ø–æ—Ä—Ç 993 –≤ firewall
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IMAP Host

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [EMAIL_SETUP.md](./EMAIL_SETUP.md) - –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Gmail App Password
- [TESTING.md](./TESTING.md) - –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [README.md](./README.md) - API –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

## üî• –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –í –∫–æ–¥–µ (tRPC/API):

```typescript
import { getOrganizationEmailConfig } from '@/server/email/utils/getOrganizationEmailConfig';
import { EmailService } from '@/server/email/services/EmailService';

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
const config = await getOrganizationEmailConfig(organizationId);

if (config) {
  const emailService = new EmailService(config);
  await emailService.connect();
  
  // –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞
  const emails = await emailService.fetchUnreadEmails(10);
  
  for (const email of emails) {
    console.log('–ù–æ–≤–æ–µ –ø–∏—Å—å–º–æ:', email.subject);
    // ... –ø–∞—Ä—Å–∏–Ω–≥ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—É–∫–∏–Ω–≥–∞
    
    await emailService.markAsRead(email.messageId);
  }
  
  emailService.disconnect();
}
```

---

## ‚úÖ Checklist –¥–ª—è production

- [ ] –°–æ–∑–¥–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –≤ Super Admin
- [ ] –ü–æ–ª—É—á–µ–Ω Gmail App Password
- [ ] Email –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- [ ] –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: `npm run email:test <org-id>`
- [ ] Email –ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Å—å–º–∞ –æ—Ç Booking.com/Airbnb
- [ ] –ì–æ—Ç–æ–≤–æ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –ø–∞—Ä—Å–µ—Ä–æ–≤!

---

## üÜò –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

**–ü—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π?**
‚Üí –°–º. [EMAIL_SETUP.md](./EMAIL_SETUP.md)

**–û—à–∏–±–∫–∏ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏?**
‚Üí –°–º. [TESTING.md](./TESTING.md)

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ?**
‚Üí –°–º. [README.md](./README.md)

